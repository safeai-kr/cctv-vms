<!DOCTYPE html>
<html>

<head>
    <title>Age and Gender Recognition</title>
    <script defer async src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script defer async src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>
    <!-- <script async src="app.js"></script> -->
</head>

<body>
    <h1>Real-time Age and Gender Recognition</h1>
    <!-- <video id="video" width="640" height="480" autoplay muted></video> -->
    <canvas id="canvas" width="640" height="480"></canvas>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            let video;

            async function setupCamera() {
                video = document.createElement('video');
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 },
                    audio: false
                });
                video.srcObject = stream;
                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        resolve(video);
                    };
                });
            }

            async function loadModels() {
                const faceModel = await blazeface.load({ inputSize: 128, doubleScoreThreshold: 0.5 });
                const agemodel = await tf.loadLayersModel('age/model.json');
                const gendermodel = await tf.loadLayersModel('gender/model.json');
                return { faceModel, agemodel, gendermodel };
            }

            function drawLabel(ctx, x, y, label) {
                ctx.fillStyle = 'blue';
                ctx.fillRect(x, y - 20, ctx.measureText(label).width + 10, 20);
                ctx.fillStyle = 'white';
                ctx.fillText(label, x + 5, y - 5);
            }

            function getAgeLabel(index) {
                const ageRanges = ['1-15', '16-30', '31-45', '46-60'];
                return ageRanges[index] || 'Unknown';
            }

            async function detect({ faceModel, agemodel, gendermodel }) {
                const predictions = await faceModel.estimateFaces(video, false);
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                for (let i = 0; i < predictions.length; i++) {
                    const start = predictions[i].topLeft;
                    const end = predictions[i].bottomRight;
                    const size = [end[0] - start[0], end[1] - start[1]];
                    const intstart = [Math.round(start[0]), Math.round(start[1])];
                    const intsize = [
                        Math.min(Math.round(size[0]), canvas.width - intstart[0]),
                        Math.min(Math.round(size[1]), canvas.height - intstart[1])
                    ];

                    if (intsize[0] < 0)
                        intsize[0] *= -1
                    if (intsize[1] < 0)
                        intsize[1] *= -1

                    ctx.beginPath();
                    ctx.rect(intstart[0], intstart[1], intsize[0], intsize[1]);
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = 'blue';
                    ctx.stroke();

                    const faceAgeGender = tf.browser.fromPixels(video)
                        .slice([intstart[1], intstart[0], 0], [intsize[1], intsize[0], 3])
                        .resizeBilinear([180, 180])
                        .mean(2)
                        .expandDims(-1)
                        .toFloat()
                        .div(tf.scalar(255.0))
                        .expandDims(0);

                    const agepred = await agemodel.predict(faceAgeGender);
                    const genderpred = await gendermodel.predict(faceAgeGender);
                    const ageArray = agepred.dataSync();
                    const maxAgeIndex = ageArray.indexOf(Math.max(...ageArray));
                    const predictedAge = getAgeLabel(maxAgeIndex);

                    const genderLabel = genderpred.dataSync()[0] > 0.537 ? 'Female' : 'Male';
                    const label = `${genderLabel}, ${predictedAge}`;

                    drawLabel(ctx, intstart[0], intstart[1], label);

                    faceAgeGender.dispose();
                    agepred.dispose();
                    genderpred.dispose();
                }

                requestAnimationFrame(() => detect({ faceModel, agemodel, gendermodel }));
            }

            (async function main() {
                await setupCamera();
                console.log("video start")
                video.play();
                console.log("video end")

                const models = await loadModels();
                console.log("detect start")
                detect(models);
                console.log("detect end")
            })();
        });
    </script>
</body>

</html>
